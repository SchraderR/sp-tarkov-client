<mat-form-field color="accent" class="search-input" appearance="outline" subscriptSizing="dynamic">
  <mat-label>Search for Mods</mat-label>
  <input matInput type="text" aria-label="State" [matAutocomplete]="auto" [formControl]="searchControl" />
  <mat-autocomplete #auto="matAutocomplete" [hideSingleSelectionIndicator]="true">
    <mat-option class="search-loading" *ngIf="isLoading && filteredModItems.length === 0">
      <mat-spinner [diameter]="50"></mat-spinner>
    </mat-option>
    @for (mod of filteredModItems; track mod) {
      <mat-option
        [value]="mod.name"
        appIsAlreadyInstalled #alreadyInstalled="isAlreadyInstalled"
        appIsAlreadyStarted #alreadyStarted="isAlreadyStarted"
        [mod]="mod"
      >
        <div class="search-item-container" (click)="$event.preventDefault(); $event.stopPropagation();">
          <img class="image-shadow" [ngSrc]="mod.thumbnail | imagePathResolver" width="70" height="70" alt="">

          <div class="mod-information-container">
            <span class="text-ellipsis" [matTooltip]="mod.name">{{ mod.name }}</span>
            <div style="display: flex;">
              <div style="display: flex; justify-content: start; align-self: end; height: fit-content">
                @let latestCompatibleModSptVersion = mod?.versions?.[0]?.spt_version_constraint | semverSptVersion;
                @if (latestCompatibleModSptVersion) {
                  <span [class]="'badge-version ' + latestCompatibleModSptVersion.color_class" class="font-x-small image-spt-version version-pill">
                    {{ latestCompatibleModSptVersion.version }}
                  </span>
                }
              </div>

              <div style="display: flex; justify-content: end; width: 100%; height: 100%">
                <button mat-icon-button (click)="$event.stopPropagation(); openExternal(mod.detail_url)">
                  <mat-icon>open_in_new</mat-icon>
                </button>

                @if (isActiveSptInstanceAvailable()) {
                  @if (mod.notSupported) {
                    <mat-icon class="mod-install-instance-warning" color="warn" matTooltip="Installation not supported">
                      info
                    </mat-icon>
                  } @else {
                    @if (!alreadyInstalled.isAlreadyInstalled() && alreadyStarted.isAlreadyStarted()) {
                      <div class="already-installed-icon-container">
                        <mat-spinner [diameter]="30"></mat-spinner>
                      </div>
                    }
                    @if (alreadyInstalled.isAlreadyInstalled()) {
                      <div class="mat-mdc-icon-button" matTooltip="Already installed">
                        <mat-icon color="accent" style="margin: unset">done_all</mat-icon>
                      </div>
                    }
                    @if (!alreadyStarted.isAlreadyStarted() && !alreadyInstalled.isInModList() && !alreadyInstalled.isAlreadyInstalled()) {
                      <button
                        mat-icon-button
                        (click)="addModToModList($event, mod)"
                        [matTooltip]="(isDownloadAndInstallInProgress | async) ? 'Add to download queue' : 'Add to list'"
                      >
                        <mat-icon>add</mat-icon>
                      </button>
                    }
                    @if (!alreadyStarted.isAlreadyStarted() && alreadyInstalled.isInModList() && !alreadyInstalled.isAlreadyInstalled()) {
                      {{ mod.installProgress?.downloadStep?.start }}
                      <button mat-icon-button (click)="removeModFromModList($event, mod)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  }
                } @else {
                  <mat-icon
                    class="mod-install-instance-warning"
                    color="warn"
                    matTooltip="Add or activate an instance of SPT to enable additional functionality">
                    warning
                  </mat-icon>
                }
              </div>
            </div>
          </div>


        </div>
      </mat-option>
    }
  </mat-autocomplete>
</mat-form-field>
